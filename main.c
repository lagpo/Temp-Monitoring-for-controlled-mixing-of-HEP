// -------------------- Configuration and Definitions -------------------- //
#define SSD1306_I2C_ADDRESS  0x78  // SSD1306 OLED I2C Address
#define DS3231_I2C_ADDRESS   0xD0  // DS3231 RTC I2C Address
#define MLX90614_I2C_ADDRESS 0x5A  // MLX90614 IR Temperature Sensor I2C Address

// -------------------- Global Variables -------------------- //
char seconds, minutes, hours, day, date, month, year;
char timeBuffer[9];   // Time format "hh:mm:ss"
char tempBuffer[10];  // Temperature format
float temp;
float atemp;

// -------------------- Function Prototypes -------------------- //
void SSD1306_Command(unsigned char cmd);
void SSD1306_Init();
void SSD1306_ClearDisplay();
void SSD1306_GotoXY(unsigned char x, unsigned char y);
void SSD1306_Print(char *text);
void SSD1306_PrintChar(unsigned char c);
void Read_RTC_Time();
char BCD_to_Decimal(char bcd);
void Format_Time();
void Display_Time();
float Read_MLX90614_Temperature(char reg);
void Format_Temperature(float temp, char *buffer);
void Display_Temperature();

// -------------------- Main Function -------------------- //
void main() {
    Delay_ms(500);  // Allow system stabilization

    I2C1_Init(400000);  // Initialize I2C at 400KHz



    // Initialize SSD1306 OLED
    SSD1306_Init();
    SSD1306_ClearDisplay();

    // Display startup message
    SSD1306_GotoXY(1, 1);
    SSD1306_Print("RTC + TEMP DISPLAY");
    Delay_ms(2000);
    SSD1306_ClearDisplay();

    while (1) {
        Read_RTC_Time();  // Read time from DS3231
        Format_Time();    // Convert time to string format
        Display_Time();   // Display time on OLED

        atemp = Read_MLX90614_Temperature(0x06);  // Read ambient temperature
        temp = Read_MLX90614_Temperature(0x07);  // Read object temperature

        Format_Temperature(temp, tempBuffer);
        Display_Temperature();  // Display temperature on OLED

        Delay_ms(1000);  // Update every second
    }
}

// -------------------- SSD1306 OLED Functions -------------------- //
void SSD1306_Command(unsigned char cmd) {
    I2C1_Start();
    I2C1_Wr(SSD1306_I2C_ADDRESS);
    I2C1_Wr(0x00);  // Command mode
    I2C1_Wr(cmd);
    I2C1_Stop();
}

const unsigned char font6x8[95][6] = {
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // Space (ASCII 32)
    {0x00, 0x00, 0x5F, 0x00, 0x00, 0x00}, // !
    {0x00, 0x07, 0x00, 0x07, 0x00, 0x00}, // "
    {0x14, 0x7F, 0x14, 0x7F, 0x14, 0x00}, // #
    {0x24, 0x2A, 0x7F, 0x2A, 0x12, 0x00}, // $
    {0x23, 0x13, 0x08, 0x64, 0x62, 0x00}, // %
    {0x36, 0x49, 0x55, 0x22, 0x50, 0x00}, // &
    {0x00, 0x05, 0x03, 0x00, 0x00, 0x00}, // '
    {0x00, 0x1C, 0x22, 0x41, 0x00, 0x00}, // (
    {0x00, 0x41, 0x22, 0x1C, 0x00, 0x00}, // )
    {0x14, 0x08, 0x3E, 0x08, 0x14, 0x00}, // *
    {0x08, 0x08, 0x3E, 0x08, 0x08, 0x00}, // +
    {0x00, 0x50, 0x30, 0x00, 0x00, 0x00}, // ,
    {0x08, 0x08, 0x08, 0x08, 0x08, 0x00}, // -
    {0x00, 0x60, 0x60, 0x00, 0x00, 0x00}, // .
    {0x20, 0x10, 0x08, 0x04, 0x02, 0x00}, // /

    {0x3E, 0x51, 0x49, 0x45, 0x3E, 0x00}, // 0
    {0x00, 0x42, 0x7F, 0x40, 0x00, 0x00}, // 1
    {0x72, 0x49, 0x49, 0x49, 0x46, 0x00}, // 2
    {0x21, 0x41, 0x45, 0x4B, 0x31, 0x00}, // 3
    {0x18, 0x14, 0x12, 0x7F, 0x10, 0x00}, // 4
    {0x27, 0x45, 0x45, 0x45, 0x39, 0x00}, // 5
    {0x3E, 0x49, 0x49, 0x49, 0x32, 0x00}, // 6
    {0x01, 0x01, 0x71, 0x0D, 0x03, 0x00}, // 7
    {0x36, 0x49, 0x49, 0x49, 0x36, 0x00}, // 8
    {0x26, 0x49, 0x49, 0x49, 0x3E, 0x00}, // 9

    {0x00, 0x36, 0x36, 0x00, 0x00, 0x00}, // :
    {0x00, 0x56, 0x36, 0x00, 0x00, 0x00}, // ;
    {0x08, 0x14, 0x22, 0x41, 0x00, 0x00}, // <
    {0x14, 0x14, 0x14, 0x14, 0x14, 0x00}, // =
    {0x00, 0x41, 0x22, 0x14, 0x08, 0x00}, // >
    {0x02, 0x01, 0x59, 0x09, 0x06, 0x00}, // ?

    {0x3E, 0x41, 0x5D, 0x59, 0x4E, 0x00}, // @

    {0x7E, 0x09, 0x09, 0x09, 0x7E, 0x00}, // A
    {0x7F, 0x49, 0x49, 0x49, 0x36, 0x00}, // B
    {0x3E, 0x41, 0x41, 0x41, 0x22, 0x00}, // C
    {0x7F, 0x41, 0x41, 0x41, 0x3E, 0x00}, // D
    {0x7F, 0x49, 0x49, 0x49, 0x41, 0x00}, // E
    {0x7F, 0x09, 0x09, 0x09, 0x01, 0x00}, // F

    {0x3E, 0x41, 0x49, 0x49, 0x2E, 0x00}, // G
    {0x7F, 0x08, 0x08, 0x08, 0x7F, 0x00}, // H
    {0x41, 0x7F, 0x41, 0x00, 0x00, 0x00}, // I
    {0x20, 0x40, 0x40, 0x40, 0x3F, 0x00}, // J
    {0x7F, 0x08, 0x14, 0x22, 0x41, 0x00}, // K
    {0x7F, 0x40, 0x40, 0x40, 0x40, 0x00}, // L
    {0x7F, 0x02, 0x04, 0x02, 0x7F, 0x00}, // M
    {0x7F, 0x04, 0x08, 0x10, 0x7F, 0x00}, // N
    {0x3E, 0x41, 0x41, 0x41, 0x3E, 0x00}, // O
    {0x7F, 0x09, 0x09, 0x09, 0x06, 0x00}, // P

    {0x3E, 0x41, 0x49, 0x49, 0x3E, 0x00}, // Q
    {0x7F, 0x09, 0x19, 0x29, 0x46, 0x00}, // R
    {0x46, 0x49, 0x49, 0x49, 0x31, 0x00}, // S
    {0x01, 0x01, 0x7F, 0x01, 0x01, 0x00}, // T
    {0x3F, 0x40, 0x40, 0x40, 0x3F, 0x00}, // U
    {0x1F, 0x20, 0x40, 0x20, 0x1F, 0x00}, // V
    {0x3F, 0x40, 0x30, 0x40, 0x3F, 0x00}, // W
    {0x63, 0x14, 0x08, 0x14, 0x63, 0x00}, // X
    {0x07, 0x08, 0x70, 0x08, 0x07, 0x00}, // Y
    {0x71, 0x49, 0x45, 0x43, 0x00, 0x00}, // Z


    {0x20, 0x54, 0x54, 0x54, 0x78, 0x00}, // a
    {0x7F, 0x48, 0x44, 0x44, 0x38, 0x00}, // b
    {0x38, 0x44, 0x44, 0x44, 0x20, 0x00}, // c
    {0x38, 0x44, 0x44, 0x48, 0x7F, 0x00}, // d
    {0x38, 0x54, 0x54, 0x54, 0x18, 0x00}, // e
    {0x08, 0x7E, 0x09, 0x01, 0x02, 0x00}, // f
    {0x0C, 0x52, 0x52, 0x52, 0x3E, 0x00}, // g
    {0x7F, 0x08, 0x04, 0x04, 0x78, 0x00}, // h
    {0x00, 0x44, 0x7D, 0x40, 0x00, 0x00}, // i
    {0x20, 0x40, 0x40, 0x3D, 0x00, 0x00}, // j
    {0x7F, 0x10, 0x28, 0x44, 0x00, 0x00}, // k
    {0x00, 0x41, 0x7F, 0x40, 0x00, 0x00}, // l
    {0x7C, 0x04, 0x18, 0x04, 0x78, 0x00}, // m
    {0x7C, 0x08, 0x04, 0x04, 0x78, 0x00}, // n
    {0x38, 0x44, 0x44, 0x44, 0x38, 0x00}, // o
    {0x7C, 0x14, 0x14, 0x14, 0x08, 0x00}, // p
    {0x08, 0x14, 0x14, 0x18, 0x7C, 0x00}, // q
    {0x7C, 0x08, 0x04, 0x04, 0x08, 0x00}, // r
    {0x48, 0x54, 0x54, 0x54, 0x20, 0x00}, // s
    {0x04, 0x3F, 0x44, 0x40, 0x20, 0x00}, // t
    {0x3C, 0x40, 0x40, 0x20, 0x7C, 0x00}, // u
    {0x1C, 0x20, 0x40, 0x20, 0x1C, 0x00}, // v
    {0x3C, 0x40, 0x30, 0x40, 0x3C, 0x00}, // w
    {0x44, 0x28, 0x10, 0x28, 0x44, 0x00}, // x
    {0x0C, 0x50, 0x50, 0x50, 0x3C, 0x00}, // y
    {0x44, 0x64, 0x54, 0x4C, 0x44, 0x00}  // z

};

// Initialize SSD1306 OLED
void SSD1306_Init() {
    SSD1306_Command(0xAE); SSD1306_Command(0xD5); SSD1306_Command(0x80);
    SSD1306_Command(0xA8); SSD1306_Command(0x3F); SSD1306_Command(0xD3); SSD1306_Command(0x00);
    SSD1306_Command(0x40); SSD1306_Command(0x8D); SSD1306_Command(0x14);
    SSD1306_Command(0x20); SSD1306_Command(0x00); SSD1306_Command(0xA1); SSD1306_Command(0xC8);
    SSD1306_Command(0xDA); SSD1306_Command(0x12); SSD1306_Command(0x81); SSD1306_Command(0xCF);
    SSD1306_Command(0xD9); SSD1306_Command(0xF1); SSD1306_Command(0xDB); SSD1306_Command(0x40);
    SSD1306_Command(0xA4); SSD1306_Command(0xA6); SSD1306_Command(0xAF);
}

// Clear SSD1306 display
void SSD1306_ClearDisplay() {
    unsigned char i, j;
    for (i = 0; i < 8; i++) {
        SSD1306_Command(0xB0 + i);
        SSD1306_Command(0x00);
        SSD1306_Command(0x10);
        for (j = 0; j < 128; j++) {
            I2C1_Start();
            I2C1_Wr(SSD1306_I2C_ADDRESS);
            I2C1_Wr(0x40);  // Data mode
            I2C1_Wr(0x00);
            I2C1_Stop();
        }
    }
}

// Move cursor to X and Y position
void SSD1306_GotoXY(unsigned char x, unsigned char y) {
    SSD1306_Command(0xB0 + y);
    SSD1306_Command(0x00 + (x & 0x0F));
    SSD1306_Command(0x10 + ((x >> 4) & 0x0F));
}

// Print text on SSD1306
void SSD1306_Print(char *text) {
    while (*text) {
        SSD1306_PrintChar(*text++);
    }
}

void SSD1306_PrintChar(unsigned char c) {
    unsigned char i;
    if (c < 32 || c > 126) c = ' ';

    I2C1_Start();
    I2C1_Wr(SSD1306_I2C_ADDRESS);
    I2C1_Wr(0x40);

    for (i = 0; i < 6; i++) {
        I2C1_Wr(font6x8[c - 32][i]);
    }

    I2C1_Stop();
}

// -------------------- DS3231 RTC Functions -------------------- //
void Read_RTC_Time() {
    I2C1_Start();
    I2C1_Wr(DS3231_I2C_ADDRESS);
    I2C1_Wr(0x00);
    I2C1_Repeated_Start();
    I2C1_Wr(DS3231_I2C_ADDRESS | 1);

    seconds = I2C1_Rd(1);
    minutes = I2C1_Rd(1);
    hours   = I2C1_Rd(1);
    day     = I2C1_Rd(1);
    date    = I2C1_Rd(1);
    month   = I2C1_Rd(1);
    year    = I2C1_Rd(0);

    I2C1_Stop();
}

char BCD_to_Decimal(char bcd) {
    return ((bcd / 16) * 10 + (bcd % 16));
}

void Format_Time() {
    seconds = BCD_to_Decimal(seconds);
    minutes = BCD_to_Decimal(minutes);
    hours   = BCD_to_Decimal(hours);

    sprinti(timeBuffer, "%02d:%02d:%02d", hours, minutes, seconds);
}

void Display_Time() {
    SSD1306_GotoXY(3, 2);
    SSD1306_Print("Time:");
    SSD1306_GotoXY(4, 4);
    SSD1306_Print(timeBuffer);
}

// -------------------- MLX90614 Temperature Functions -------------------- //
float Read_MLX90614_Temperature(char reg) {
    unsigned int dataLow, dataHigh;
    I2C1_Start();
    I2C1_Wr(MLX90614_I2C_ADDRESS << 1);
    I2C1_Wr(reg);
    I2C1_Repeated_Start();
    I2C1_Wr((MLX90614_I2C_ADDRESS << 1) | 1);
    dataLow = I2C1_Rd(1);
    dataHigh = I2C1_Rd(0);
    I2C1_Stop();
    return ((dataHigh << 8) | dataLow) * 0.02 - 273.15;
}

void Format_Temperature(float temp, char *buffer) {
    sprinti(buffer, "%.2f C", temp);
}

void Display_Temperature() {
    SSD1306_GotoXY(2, 6);
    SSD1306_Print("TEMP:");
    SSD1306_GotoXY(6, 6);
    SSD1306_Print(tempBuffer);
}
